<div class="deposits-page">
  <h2><mat-icon>savings</mat-icon> Deposits</h2>

  @if (auth.isAdmin()) {
    <section>
      <mat-card class="deposit-form-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>add_circle</mat-icon>
          <mat-card-title>Record New Deposit</mat-card-title>
          <mat-card-subtitle>Add a deposit for a member</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <form (ngSubmit)="onSubmit()" class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Member</mat-label>
              <mat-select [(ngModel)]="newDeposit.user_id" name="user_id" required>
                @for (member of members(); track member.id) {
                  <mat-option [value]="member.id">{{ member.name }}</mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Amount (₹)</mat-label>
              <input matInput type="number" [(ngModel)]="newDeposit.amount" name="amount" step="300" min="300" required />
              <mat-icon matPrefix>currency_rupee</mat-icon>
              <mat-hint>Minimum ₹300</mat-hint>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Member Month</mat-label>
              <input matInput type="number" [(ngModel)]="newDeposit.member_month" name="member_month" min="1" required />
              <mat-icon matPrefix>calendar_month</mat-icon>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Date</mat-label>
              <input matInput type="date" [(ngModel)]="newDeposit.deposit_date" name="deposit_date" required />
              <mat-icon matPrefix>event</mat-icon>
            </mat-form-field>
            
            <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
              @if (loading()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                Record Deposit
              }
            </button>
          </form>
        </mat-card-content>
      </mat-card>
    </section>
  }

  <section>
    <mat-card class="history-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>history</mat-icon>
        <mat-card-title>Deposit History</mat-card-title>
        <mat-card-subtitle>{{ deposits().length }} deposits recorded</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (auth.isAdmin()) {
          <!-- Admin view: grouped by person with expansion panels -->
          @if (groupedDeposits().length) {
            <mat-accordion multi>
              @for (group of groupedDeposits(); track group.userId) {
                <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon>person</mat-icon>
                      {{ group.userName }}
                    </mat-panel-title>
                    <mat-panel-description>
                      <span class="panel-stats">
                        <span class="stat">{{ group.deposits.length }} deposits</span>
                        <span class="stat total">Total: {{ group.latestCumulative | currency:'INR' }}</span>
                      </span>
                    </mat-panel-description>
                  </mat-expansion-panel-header>
                  
                  <div class="table-container">
                    <table mat-table [dataSource]="group.deposits">
                      <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef>Amount</th>
                        <td mat-cell *matCellDef="let deposit" class="amount-cell">{{ deposit.amount | currency:'INR' }}</td>
                      </ng-container>
                      
                      <ng-container matColumnDef="member_month">
                        <th mat-header-cell *matHeaderCellDef>Month</th>
                        <td mat-cell *matCellDef="let deposit">Month {{ deposit.member_month }}</td>
                      </ng-container>
                      
                      <ng-container matColumnDef="deposit_date">
                        <th mat-header-cell *matHeaderCellDef>Date</th>
                        <td mat-cell *matCellDef="let deposit">{{ deposit.deposit_date | date:'mediumDate' }}</td>
                      </ng-container>
                      
                      <ng-container matColumnDef="cumulative_total">
                        <th mat-header-cell *matHeaderCellDef>Cumulative Total</th>
                        <td mat-cell *matCellDef="let deposit" class="cumulative-cell">{{ deposit.cumulative_total | currency:'INR' }}</td>
                      </ng-container>
                      
                      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>
                  </div>
                </mat-expansion-panel>
              }
            </mat-accordion>
          } @else {
            <div class="empty-state">
              <mat-icon>savings</mat-icon>
              <span>No deposits found</span>
            </div>
          }
        } @else {
          <!-- Regular user view: simple table -->
          @if (deposits().length) {
            <div class="table-container">
              <table mat-table [dataSource]="deposits()">
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>Amount</th>
                  <td mat-cell *matCellDef="let deposit" class="amount-cell">{{ deposit.amount | currency:'INR' }}</td>
                </ng-container>
                
                <ng-container matColumnDef="member_month">
                  <th mat-header-cell *matHeaderCellDef>Month</th>
                  <td mat-cell *matCellDef="let deposit">Month {{ deposit.member_month }}</td>
                </ng-container>
                
                <ng-container matColumnDef="deposit_date">
                  <th mat-header-cell *matHeaderCellDef>Date</th>
                  <td mat-cell *matCellDef="let deposit">{{ deposit.deposit_date | date:'mediumDate' }}</td>
                </ng-container>
                
                <ng-container matColumnDef="cumulative_total">
                  <th mat-header-cell *matHeaderCellDef>Cumulative Total</th>
                  <td mat-cell *matCellDef="let deposit" class="cumulative-cell">{{ deposit.cumulative_total | currency:'INR' }}</td>
                </ng-container>
                
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              </table>
            </div>
          } @else {
            <div class="empty-state">
              <mat-icon>savings</mat-icon>
              <span>No deposits found</span>
            </div>
          }
        }
      </mat-card-content>
    </mat-card>
  </section>
</div>
