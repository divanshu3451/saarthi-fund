<div class="loans-page">
  <h2><mat-icon>account_balance</mat-icon> Loans</h2>

  <section>
    <mat-card class="eligibility-card" [class.eligible]="eligibility()?.eligible" [class.not-eligible]="!eligibility()?.eligible">
      <mat-card-header>
        <mat-icon mat-card-avatar>{{ eligibility()?.eligible ? 'check_circle' : 'cancel' }}</mat-icon>
        <mat-card-title>Loan Eligibility</mat-card-title>
        <mat-card-subtitle>{{ eligibility()?.eligible ? 'You are eligible for a loan' : 'Not eligible at this time' }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="eligibility-stats">
          <div class="stat-item">
            <span class="stat-label">Your Deposits</span>
            <span class="stat-value">{{ eligibility()?.totalDeposits | currency:'INR' }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Max Multiplier</span>
            <span class="stat-value">{{ eligibility()?.maxMultiplier }}x</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Outstanding</span>
            <span class="stat-value">{{ eligibility()?.outstanding | currency:'INR' }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Max Eligible</span>
            <span class="stat-value highlight">{{ eligibility()?.maxEligible | currency:'INR' }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Active Loans</span>
            <span class="stat-value">{{ eligibility()?.activeLoans }} / {{ eligibility()?.maxActiveLoans }}</span>
          </div>
        </div>
        
        @if (eligibility()?.eligible) {
          <form (ngSubmit)="requestLoan()" class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Loan Amount (₹)</mat-label>
              <input matInput type="number" [(ngModel)]="loanAmount" name="amount" [max]="eligibility()?.maxEligible || 0" min="1" required />
              <mat-icon matPrefix>currency_rupee</mat-icon>
              <mat-hint>Max: {{ eligibility()?.maxEligible | currency:'INR' }}</mat-hint>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>EMI Start Date (optional)</mat-label>
              <input matInput type="date" [(ngModel)]="emiStartDate" name="emi_start_date" />
              <mat-icon matPrefix>event</mat-icon>
              <mat-hint>Leave empty to start EMI later</mat-hint>
            </mat-form-field>
            
            <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
              @if (loading()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <ng-container>
                  <!-- <mat-icon>send</mat-icon> -->
                  Request Loan
                </ng-container>
              }
            </button>
          </form>
        } @else {
          <div class="not-eligible-message">
            <mat-icon>info</mat-icon>
            <span>{{ eligibility()?.reason || 'You are not eligible for a loan at this time.' }}</span>
          </div>
        }
      </mat-card-content>
    </mat-card>
  </section>

  <section>
    <h3><mat-icon>list</mat-icon> My Loans</h3>
    @if (loans().length) {
      <div class="loans-grid">
        @for (loan of loans(); track loan.id) {
          <mat-card class="loan-card" [routerLink]="['/loans', loan.id]">
            <mat-card-header>
              <mat-icon mat-card-avatar>receipt_long</mat-icon>
              <mat-card-title>{{ loan.principal_amount | currency:'INR' }}</mat-card-title>
              <mat-card-subtitle>
                @if (auth.isAdmin() && loan.users_loans_user_idTousers) {
                  {{ loan.users_loans_user_idTousers.name }} •
                }
                <mat-chip class="status-chip" [class]="loan.status">{{ loan.status }}</mat-chip>
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="loan-info">
                <div class="loan-row">
                  <span class="label">Interest Rate</span>
                  <span class="value rate">{{ loan.interest_rate }}%</span>
                </div>
                <div class="loan-row">
                  <span class="label">Multiplier</span>
                  <span class="value">{{ loan.multiplier_at_disbursement }}x</span>
                </div>
                <div class="loan-row">
                  <span class="label">Disbursed</span>
                  <span class="value">{{ loan.disbursed_at | date:'mediumDate' }}</span>
                </div>
                <div class="loan-row">
                  <span class="label">Outstanding</span>
                  <span class="value outstanding">{{ loan.outstanding_principal | currency:'INR' }}</span>
                </div>
                <div class="loan-row">
                  <span class="label">EMI Status</span>
                  <span class="value">
                    @if (loan.emi_start_date) {
                      Started {{ loan.emi_start_date | date:'mediumDate' }}
                    } @else {
                      <em>Not started</em>
                    }
                  </span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    } @else {
      <div class="empty-state">
        <mat-icon>account_balance</mat-icon>
        <span>No loans found</span>
      </div>
    }
  </section>
</div>
